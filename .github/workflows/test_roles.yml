name: Test Python 3.9 - Ubuntu Latest

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
jobs:

  test:
    name: Run Tests

    runs-on: ubuntu-latest

    steps:
      - name: Show HOME
        run: echo $HOME
      - name: Checkout net_models
        uses: actions/checkout@v2
        with:
          repository: mihudec/net_models
          path: './net_models'

      - name: Checkout net_templates
        uses: actions/checkout@v2
        with:
          repository: mihudec/net_templates
          path: './net_templates'

      - name: Set up Python 3.9
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      
      - name: Install Ansible and requirements
        run:
          pip install ansible jmespath netaddr

      - name: Install net_models
        run: |
          cd ./net_models/
          python setup.py install
          cd ..

      - name: Install net_templates
        run: |
          cd ./net_templates/
          python setup.py install
          cd ..
      
      - name: Install net_ansible Collection
        run: |
          mkdir -p ./collections/ansible_collections/mihudec/
          cd ./collections/ansible_collections
          export ANSIBLE_COLLECTIONS_PATH=$(pwd)
          cd ../../

      - name: Checkout net_ansible
        uses: actions/checkout@v2
        with:
          repository: mihudec/net_ansible
          path: './collections/ansible_collections/mihudec/net_ansible'

      - name: Setup Templates Symlinks
        run: |
          python ./collections/ansible_collections/mihudec/net_ansible/plugins/module_utils/create_templates_symlink.py 

      - name: Checkout net_ansible_tests
        uses: actions/checkout@v2
        with:
          path: './net_ansible_tests'

      - name: Run Tests
        run: |
          cd ./net_ansible_tests
          chmod +x run_tests.sh
          ./run_tests.sh

      